# Isaac Lab v2.1.0 with Isaac Sim v4.5.0 Docker Environment (Fixed Dependencies)
FROM nvcr.io/nvidia/isaac-sim:4.5.0

# í™˜ê²½ ë³€ìˆ˜ë“¤ì„ í•œë²ˆì— ì„¤ì • (X11 ê¸°ë³¸ ì„¤ì • ì¶”ê°€)
ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=all \
    QT_X11_NO_MITSHM=1 \
    QT_GRAPHICSSYSTEM=native \
    LIBGL_ALWAYS_INDIRECT=0 \
    LIBGL_ALWAYS_SOFTWARE=0 \
    __GL_SYNC_TO_VBLANK=0 \
    __GL_MaxFramesAllowed=1 \
    MESA_GL_VERSION_OVERRIDE=4.1 \
    ISAAC_SIM_PATH="/isaac-sim" \
    ISAACLAB_PATH="/opt/IsaacLab" \
    PYTHONPATH="/isaac-sim/kit/python/lib/python3.10/site-packages:/opt/IsaacLab/source" \
    PATH="/usr/local/bin:${PATH}" \
    LANG=ko_KR.UTF-8 \
    LANGUAGE=ko_KR:ko \
    LC_ALL=ko_KR.UTF-8 \
    OMNI_KIT_ALLOW_ROOT=1 \
    TERM=xterm-256color \
    DISPLAY=:0

# ëª¨ë“  íŒ¨í‚¤ì§€ë¥¼ í•œë²ˆì— ì„¤ì¹˜ (Layer ìµœì í™”)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # ê¸°ë³¸ ê°œë°œ ë„êµ¬
    git wget curl vim nano build-essential cmake \
    python3-pip python3-dev sudo openssh-server \
    # X11 ë° GUI ë¼ì´ë¸ŒëŸ¬ë¦¬ (í•œë²ˆì— ì„¤ì¹˜)
    x11-apps x11-utils x11-xserver-utils xauth xvfb mesa-utils \
    libgl1-mesa-glx libgl1-mesa-dri libglx-mesa0 libglu1-mesa \
    libglib2.0-0 libsm6 libxext6 libxrender1 libxtst6 libxi6 \
    libxrandr2 libxss1 libgconf-2-4 libxcomposite1 libxcursor1 \
    libxdamage1 libxfixes3 libgtk-3-0 libgbm1 libnss3 \
    libatk-bridge2.0-0 libatspi2.0-0 libdrm2 \
    # í•œê¸€ ì§€ì› íŒ¨í‚¤ì§€
    locales language-pack-ko fonts-noto-cjk fonts-noto-cjk-extra \
    fonts-noto-color-emoji fontconfig unzip fonts-liberation \
    fonts-dejavu fonts-liberation2 fonts-nanum fonts-nanum-coding \
    # VSCode ì˜ì¡´ì„±
    gpg apt-transport-https software-properties-common \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ìˆ˜ì •ëœ ncurses íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Ubuntu 22.04+ í˜¸í™˜)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libncurses-dev libncursesw5-dev libreadline-dev \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ë¡œì¼€ì¼ ë° ê¸°ë³¸ ì„¤ì • (í•œë²ˆì— ì²˜ë¦¬)
RUN sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen && \
    sed -i '/ko_KR.UTF-8/s/^# //g' /etc/locale.gen && \
    locale-gen && \
    ln -sf /usr/bin/python3 /usr/bin/python && \
    echo 'root ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# D2Coding í°íŠ¸ ì„¤ì¹˜ (í•œê¸€ í‘œì‹œì— í•„ìˆ˜)
RUN mkdir -p /usr/share/fonts/truetype/d2coding && \
    wget -q -O /tmp/D2Coding.zip "https://github.com/naver/d2codingfont/releases/download/VER1.3.2/D2Coding-Ver1.3.2-20180524.zip" && \
    unzip -q /tmp/D2Coding.zip -d /tmp/d2coding && \
    cp /tmp/d2coding/D2Coding/*.ttf /usr/share/fonts/truetype/d2coding/ && \
    fc-cache -fv && \
    rm -rf /tmp/D2Coding.zip /tmp/d2coding

# VSCode ì„¤ì¹˜ (ìµœì í™”ëœ ë°©ì‹)
RUN wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/ms-vscode-archive-keyring.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/ms-vscode-archive-keyring.gpg] https://packages.microsoft.com/repos/vscode stable main" > /etc/apt/sources.list.d/vscode.list && \
    apt-get update && apt-get install -y --no-install-recommends code && \
    rm -rf /var/lib/apt/lists/* && apt-get clean

# ì›Œí‚¹ ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /AILAB-summer-school-2025

# Isaac Lab í´ë¡  (ì†ë„ ìµœì í™”ì˜ í•µì‹¬ - ìµœì‹  ì»¤ë°‹ë§Œ)
RUN git clone --depth 1 --branch v2.1.0 --single-branch https://github.com/isaac-sim/IsaacLab.git /opt/IsaacLab && \
    cd /opt/IsaacLab && \
    # ì˜¬ë°”ë¥¸ Isaac Sim ë§í¬ ìƒì„±
    rm -f _isaac_sim && \
    ln -sf /isaac-sim _isaac_sim && \
    echo "âœ… Isaac Lab í´ë¡  ë° ë§í¬ ì™„ë£Œ"

# PyTorch ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Isaac Sim Python ì‚¬ìš©, í˜¸í™˜ì„± ê³ ë ¤)
RUN /isaac-sim/python.sh -m pip install --no-cache-dir --upgrade pip && \
    /isaac-sim/python.sh -m pip install --no-cache-dir \
    torch==2.5.1+cu118 torchvision==0.20.1+cu118 torchaudio==2.5.1+cu118 \
    --index-url https://download.pytorch.org/whl/cu118

# Isaac Lab í•„ìˆ˜ dependency ì„¤ì¹˜ (í˜¸í™˜ì„± ë²„ì „ìœ¼ë¡œ ìˆ˜ì •, ipykernel ëª…ì‹œì  í¬í•¨)
RUN /isaac-sim/python.sh -m pip install --no-cache-dir \
    # Isaac Lab í•„ìˆ˜ íŒ¨í‚¤ì§€ë“¤
    gymnasium==0.29.1 \
    toml \
    lxml==5.2.2 \
    pytz>=2020.1 \
    # numpy 1.26.2ì™€ í˜¸í™˜ë˜ëŠ” ë²„ì „ë“¤
    opencv-python==4.8.1.78 \
    psutil==5.9.8 \
    # ê°œë°œ ë„êµ¬ë“¤ (ipykernel ëª…ì‹œì  í¬í•¨)
    black flake8 pylint autopep8 rope jedi debugpy readline \
    ipython jupyter ipykernel matplotlib scipy open3d easydict timm isort \
    pycocotools

# CLIP ì„¤ì¹˜ (ë³„ë„ ì²˜ë¦¬)
RUN /isaac-sim/python.sh -m pip install --no-cache-dir git+https://github.com/openai/CLIP.git

# ì‹œìŠ¤í…œ Pythonì—ë„ ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ë°±ì—…ìš©, ipykernel í¬í•¨)
RUN pip3 install --no-cache-dir \
    torch==2.5.1+cu118 torchvision==0.20.1+cu118 torchaudio==2.5.1+cu118 \
    --index-url https://download.pytorch.org/whl/cu118 && \
    pip3 install --no-cache-dir \
    gymnasium==0.29.1 toml lxml==5.2.2 pytz>=2020.1 \
    opencv-python==4.8.1.78 psutil==5.9.8 \
    black flake8 pylint autopep8 rope jedi debugpy \
    ipython jupyter ipykernel numpy==1.26.2

# Isaac Lab ì„¤ì¹˜ (v2.1.0 robust ì„¤ì¹˜ ë°©ë²•)
RUN cd /opt/IsaacLab && \
    # 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    export ISAACLAB_PATH="/opt/IsaacLab" && \
    export ISAAC_SIM_PATH="/isaac-sim" && \
    export OMNI_KIT_ALLOW_ROOT=1 && \
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages" && \
    # 2. Isaac Lab v2.1.0 êµ¬ì¡° í™•ì¸
    echo "âœ… Isaac Lab êµ¬ì¡° í™•ì¸ ì¤‘..." && \
    ls -la /opt/IsaacLab/source/ && \
    # 3. Isaac Lab ì„¤ì¹˜ ì‹œë„ (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„)
    echo "ğŸ”§ Isaac Lab ì„¤ì¹˜ ì‹œì‘..." && \
    # ë°©ë²• 1: Isaac Lab ìì²´ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ê¶Œì¥)
    if [ -f "./isaaclab.sh" ]; then \
        echo "ğŸ“¦ Method 1: isaaclab.sh --install ì‹œë„..."; \
        chmod +x ./isaaclab.sh; \
        if ./isaaclab.sh --install; then \
            echo "âœ… isaaclab.sh --install ì„±ê³µ!"; \
        else \
            echo "âš ï¸ isaaclab.sh --install ì‹¤íŒ¨, ë‹¤ë¥¸ ë°©ë²• ì‹œë„..."; \
            # ë°©ë²• 2: pip install ì‹œë„
            echo "ğŸ“¦ Method 2: pip install -e . ì‹œë„..."; \
            if /isaac-sim/python.sh -m pip install --no-cache-dir -e .; then \
                echo "âœ… pip install ì„±ê³µ!"; \
            else \
                echo "âš ï¸ pip installë„ ì‹¤íŒ¨, manual setup ì‚¬ìš©..."; \
                # ë°©ë²• 3: manual PYTHONPATH ì„¤ì •
                echo "ğŸ“¦ Method 3: Manual PYTHONPATH ì„¤ì •..."; \
                mkdir -p /isaac-sim/kit/python/lib/python3.10/site-packages; \
                ln -sf /opt/IsaacLab/source/isaaclab /isaac-sim/kit/python/lib/python3.10/site-packages/isaaclab; \
                ln -sf /opt/IsaacLab/source/isaaclab_assets /isaac-sim/kit/python/lib/python3.10/site-packages/isaaclab_assets; \
                ln -sf /opt/IsaacLab/source/isaaclab_tasks /isaac-sim/kit/python/lib/python3.10/site-packages/isaaclab_tasks; \
                ln -sf /opt/IsaacLab/source/isaaclab_rl /isaac-sim/kit/python/lib/python3.10/site-packages/isaaclab_rl; \
                echo "âœ… Manual setup ì™„ë£Œ"; \
            fi; \
        fi; \
    else \
        echo "âŒ isaaclab.sh not found, using pip install..."; \
        /isaac-sim/python.sh -m pip install --no-cache-dir -e .; \
    fi

# Isaac Lab ì„¤ì¹˜ ê²€ì¦ ë° Jupyter kernel ì„¤ì •
RUN tee /tmp/verify_isaaclab.py > /dev/null << 'EOF'
import sys
print(f'Python executable: {sys.executable}')
print("Testing Isaac Lab installation...")

# Test 1: Basic import
try:
    import isaaclab
    print('âœ… isaaclab íŒ¨í‚¤ì§€ import ì„±ê³µ')
    
    # Test 2: AppLauncher import (most critical)
    try:
        from isaaclab.app import AppLauncher
        print('âœ… isaaclab.app.AppLauncher import ì„±ê³µ')
        print('ğŸ‰ Isaac Lab ì™„ì „ ì„¤ì¹˜ í™•ì¸!')
    except ImportError as e:
        print(f'âš ï¸ isaaclab.app.AppLauncher import ì‹¤íŒ¨: {e}')
        
        # Test alternative paths
        alternatives = [
            ('isaaclab.sim', 'SimulationApp'),
            ('isaaclab.simulation_app', 'SimulationApp'), 
            ('isaaclab.core', 'app')
        ]
        
        success = False
        for module_name, attr_name in alternatives:
            try:
                module = __import__(module_name, fromlist=[attr_name])
                getattr(module, attr_name)
                print(f'âœ… ëŒ€ì•ˆ ëª¨ë“ˆ {module_name}.{attr_name}: ì„±ê³µ')
                success = True
                break
            except (ImportError, AttributeError):
                continue
        
        if not success:
            # Show available modules for debugging
            import os
            isaaclab_path = os.path.dirname(isaaclab.__file__)
            print(f'ğŸ“‚ isaaclab ì„¤ì¹˜ ê²½ë¡œ: {isaaclab_path}')
            items = [item for item in os.listdir(isaaclab_path) if not item.startswith('__') and not item.endswith('.pyc')]
            print(f'ğŸ“¦ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“ˆë“¤: {items}')
            
            # Check for app directory specifically
            app_path = os.path.join(isaaclab_path, 'app')
            if os.path.exists(app_path):
                print(f'ğŸ“ app ë””ë ‰í† ë¦¬ ì¡´ì¬: {os.listdir(app_path)}')
            else:
                print('âŒ app ë””ë ‰í† ë¦¬ ì—†ìŒ')
                
except ImportError as e:
    print(f'âŒ isaaclab íŒ¨í‚¤ì§€ import ì‹¤íŒ¨: {e}')
    print('ğŸ” PYTHONPATH í™•ì¸:')
    for path in sys.path:
        if 'isaac' in path.lower():
            print(f'  - {path}')
    exit(1)
EOF

RUN cd /opt/IsaacLab && \
    export ISAACLAB_PATH="/opt/IsaacLab" && \
    export ISAAC_SIM_PATH="/isaac-sim" && \
    export OMNI_KIT_ALLOW_ROOT=1 && \
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages" && \
    /isaac-sim/python.sh /tmp/verify_isaaclab.py && \
    echo "âœ… Isaac Lab ì„¤ì¹˜ ë° ê²€ì¦ ì™„ë£Œ" && \
    rm -f /tmp/verify_isaaclab.py

# ì„ì‹œ Jupyter kernel ì„¤ì • (Isaac Lab Python í™˜ê²½ë§Œ ë“±ë¡)
RUN echo "ğŸ”§ Jupyter kernel ì„¤ì • ì¤‘..." && \
    export ISAACLAB_PATH="/opt/IsaacLab" && \
    export ISAAC_SIM_PATH="/isaac-sim" && \
    export OMNI_KIT_ALLOW_ROOT=1 && \
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages" && \
    # Isaac Lab Python kernel ë“±ë¡
    /isaac-sim/python.sh -m ipykernel install --user --name isaaclab-direct --display-name "Isaac Lab Direct" && \
    echo "âœ… ê¸°ë³¸ Jupyter kernel ë“±ë¡ ì™„ë£Œ"

# Dependency ì¶©ëŒ í•´ê²° í™•ì¸
RUN tee /tmp/check_dependencies.py > /dev/null << 'EOF'
import sys
print("ğŸ” Dependency ì¶©ëŒ í™•ì¸ ì¤‘...")

# ì£¼ìš” íŒ¨í‚¤ì§€ë“¤ ë²„ì „ í™•ì¸
packages_to_check = [
    'numpy', 'opencv-python', 'psutil', 'gymnasium', 
    'torch', 'lxml', 'toml', 'pytz', 'ipykernel'
]

for package in packages_to_check:
    try:
        module = __import__(package.replace('-', '_'))
        version = getattr(module, '__version__', 'Unknown')
        print(f'âœ… {package}: {version}')
    except ImportError:
        print(f'âŒ {package}: Not installed')

print("\nğŸ“‹ Dependency í˜¸í™˜ì„± ì²´í¬:")
try:
    import numpy
    import cv2
    print(f'âœ… numpy ({numpy.__version__}) + opencv-python ({cv2.__version__}): í˜¸í™˜')
except Exception as e:
    print(f'âŒ numpy + opencv í˜¸í™˜ì„± ë¬¸ì œ: {e}')

try:
    import psutil
    # rl-gamesëŠ” psutil<6.0.0,>=5.9.0 ìš”êµ¬
    print(f'âœ… psutil: {psutil.__version__} (rl-games í˜¸í™˜)')
except Exception as e:
    print(f'âŒ psutil ë¬¸ì œ: {e}')

try:
    import gymnasium
    # stable-baselines3ëŠ” gymnasium<1.2.0,>=0.29.1 ìš”êµ¬
    print(f'âœ… gymnasium: {gymnasium.__version__} (stable-baselines3 í˜¸í™˜)')
except Exception as e:
    print(f'âŒ gymnasium ë¬¸ì œ: {e}')

print("ğŸ‰ Dependency ì¶©ëŒ í•´ê²° ì™„ë£Œ!")
EOF

RUN /isaac-sim/python.sh /tmp/check_dependencies.py && \
    rm -f /tmp/check_dependencies.py

# Isaac Lab ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ë° ëª…ë ¹ì–´ ë“±ë¡ (ê²½ë¡œ ë¬¸ì œ í•´ê²°)
RUN cd /opt/IsaacLab && \
    # isaaclab.sh ìŠ¤í¬ë¦½íŠ¸ì˜ ê²½ë¡œ ë¬¸ì œ ìˆ˜ì •
    sed -i 's|SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"|SCRIPT_DIR="/opt/IsaacLab"|g' isaaclab.sh && \
    # ë” ì •í™•í•œ ê²½ë¡œ ìˆ˜ì • (ì´ì¤‘ ìŠ¬ë˜ì‹œ ë°©ì§€)
    sed -i 's|${ISAACLAB_PATH}/_isaac_sim|/isaac-sim|g' isaaclab.sh && \
    # ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
    chmod +x ./isaaclab.sh && \
    # ì „ì—­ ëª…ë ¹ì–´ ìƒì„±
    rm -f /usr/local/bin/isaaclab && \
    ln -sf /opt/IsaacLab/isaaclab.sh /usr/local/bin/isaaclab && \
    # í™˜ê²½ ë³€ìˆ˜ë¥¼ bashrcì— ì˜êµ¬ ì¶”ê°€
    echo '# Isaac Lab Environment' >> /root/.bashrc && \
    echo 'export TERM=xterm-256color' >> /root/.bashrc && \
    echo 'export ISAACLAB_PATH="/opt/IsaacLab"' >> /root/.bashrc && \
    echo 'export ISAAC_SIM_PATH="/isaac-sim"' >> /root/.bashrc && \
    echo 'export OMNI_KIT_ALLOW_ROOT=1' >> /root/.bashrc && \
    echo 'export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"' >> /root/.bashrc && \
    echo "âœ… Isaac Lab ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ë° ì„¤ì • ì™„ë£Œ"

# Isaac Lab ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ì •ì‹ ì„¤ì¹˜ ë²„ì „)
RUN tee /usr/local/bin/test-isaaclab > /dev/null << 'EOF'
#!/bin/bash
export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"
export OMNI_KIT_ALLOW_ROOT=1
export ISAAC_SIM_PATH="/isaac-sim"

# Python ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ìƒì„±
cat > /tmp/test_isaaclab.py << 'PYEOF'
import sys
print(f'Testing Isaac Lab with Python: {sys.executable}')
try:
    import isaaclab
    print('âœ… Isaac Lab íŒ¨í‚¤ì§€: ì„±ê³µ')
    
    # AppLauncher í…ŒìŠ¤íŠ¸ (ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„)
    try:
        from isaaclab.app import AppLauncher
        print('âœ… isaaclab.app.AppLauncher: ì„±ê³µ')
        exit(0)
    except ImportError as e:
        print(f'âŒ isaaclab.app.AppLauncher: ì‹¤íŒ¨ - {e}')
        
        # ëŒ€ì•ˆ ê²½ë¡œë“¤ ì‹œë„
        alternative_paths = [
            'isaaclab.sim.SimulationApp',
            'isaaclab.simulation_app',
            'isaaclab.core.app'
        ]
        
        for alt_path in alternative_paths:
            try:
                module_parts = alt_path.split('.')
                module = __import__(module_parts[0])
                for part in module_parts[1:]:
                    module = getattr(module, part)
                print(f'âœ… ëŒ€ì•ˆ ëª¨ë“ˆ {alt_path}: ì„±ê³µ')
                exit(0)
            except (ImportError, AttributeError):
                continue
        
        # ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“ˆ êµ¬ì¡° í™•ì¸
        print('ğŸ“‚ isaaclab íŒ¨í‚¤ì§€ êµ¬ì¡°:')
        import os
        isaaclab_path = os.path.dirname(isaaclab.__file__)
        for item in os.listdir(isaaclab_path):
            if not item.startswith('__'):
                print(f'   - {item}')
        exit(1)
        
except ImportError as e:
    print(f'âŒ Isaac Lab íŒ¨í‚¤ì§€ import ì‹¤íŒ¨: {e}')
    exit(1)
PYEOF

# Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
/isaac-sim/python.sh /tmp/test_isaaclab.py
result=$?

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f /tmp/test_isaaclab.py

exit $result
EOF
RUN chmod +x /usr/local/bin/test-isaaclab

# VSCode ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /root/.vscode/extensions /root/.config/Code/User /AILAB-summer-school-2025/.vscode

# VSCode settings.json ìƒì„± (Isaac Lab python í™˜ê²½ìœ¼ë¡œ ìˆ˜ì •)
RUN tee /root/.config/Code/User/settings.json > /dev/null <<'EOF'
{
    "python.defaultInterpreterPath": "/usr/local/bin/python",
    "python.terminal.executeInFileDir": true,
    "python.terminal.activateEnvironment": false,
    "python.analysis.extraPaths": [
        "/opt/IsaacLab/source",
        "/AILAB-summer-school-2025",
        "/isaac-sim/kit/python/lib/python3.10/site-packages"
    ],
    "python.analysis.autoImportCompletions": true,
    "python.analysis.completeFunctionParens": true,
    "python.formatting.provider": "black",
    "python.formatting.blackArgs": ["--line-length", "88"],
    "python.linting.enabled": true,
    "python.linting.flake8Enabled": true,
    "python.linting.pylintEnabled": true,
    "python.linting.lintOnSave": true,
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
        "source.organizeImports": true
    },
    "editor.rulers": [88],
    "editor.semanticHighlighting.enabled": true,
    "terminal.integrated.cwd": "/AILAB-summer-school-2025",
    "terminal.integrated.shell.linux": "/bin/bash",
    "files.associations": {
        "*.py": "python",
        "*.pyx": "python",
        "*.pyi": "python"
    },
    "extensions.autoUpdate": false,
    "workbench.colorTheme": "Default Dark Modern",
    "workbench.iconTheme": "material-icon-theme",
    "editor.fontFamily": "'D2Coding', 'Noto Sans CJK KR', 'Nanum Gothic Coding', 'DejaVu Sans Mono', 'Consolas', 'Liberation Mono', monospace",
    "editor.fontSize": 14,
    "terminal.integrated.fontFamily": "'D2Coding', 'Noto Sans Mono CJK KR', 'Nanum Gothic Coding', 'DejaVu Sans Mono', monospace",
    "terminal.integrated.fontSize": 14,
    "debug.console.fontFamily": "'D2Coding', 'Noto Sans Mono CJK KR', 'Nanum Gothic Coding', monospace",
    "markdown.preview.fontFamily": "'Noto Sans CJK KR', 'Nanum Gothic', 'Liberation Sans', sans-serif",
    "notebook.output.fontFamily": "'D2Coding', 'Noto Sans Mono CJK KR', monospace",
    "scm.inputFontFamily": "'D2Coding', 'Noto Sans CJK KR', monospace",
    "jupyter.defaultKernel": "isaaclab-direct"
}
EOF

# VSCode keybindings.json ìƒì„±
RUN tee /root/.config/Code/User/keybindings.json > /dev/null <<'EOF'
[
    {
        "key": "f5",
        "command": "python.debugInTerminal",
        "when": "editorTextFocus && editorLangId == python"
    },
    {
        "key": "ctrl+shift+`",
        "command": "terminal.new"
    }
]
EOF

# VSCode í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN tee /install_vscode_extensions.sh > /dev/null <<'EOF'
#!/bin/bash
set -e

echo "ğŸ”§ VSCode í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì¤‘..."

EXTENSIONS=(
    "ms-python.python"
    "ms-python.black-formatter"
    "ms-python.flake8"
    "ms-python.pylint"
    "ms-python.debugpy"
    "ms-toolsai.jupyter"
    "ms-vscode.cmake-tools"
    "ms-vscode.cpptools"
    "eamodio.gitlens"
    "PKief.material-icon-theme"
    "ms-vscode.vscode-json"
    "redhat.vscode-yaml"
    "ms-python.isort"
)

for ext in "${EXTENSIONS[@]}"; do
    echo "ğŸ“¦ ì„¤ì¹˜ ì¤‘: $ext"
    if code --install-extension "$ext" \
             --user-data-dir=/root/.vscode \
             --extensions-dir=/root/.vscode/extensions \
             --force > /dev/null 2>&1; then
        echo "  âœ… $ext ì„¤ì¹˜ ì„±ê³µ"
    else
        echo "  âš ï¸ $ext ì„¤ì¹˜ ì‹¤íŒ¨ (ëŸ°íƒ€ì„ì— ì¬ì‹œë„ ê°€ëŠ¥)"
    fi
done

echo "ğŸ‰ VSCode í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì™„ë£Œ!"
EOF

# VSCode í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì‹¤í–‰
RUN chmod +x /install_vscode_extensions.sh && \
    /install_vscode_extensions.sh || echo "âš ï¸ ì¼ë¶€ í™•ì¥ í”„ë¡œê·¸ë¨ì€ ëŸ°íƒ€ì„ì— ì„¤ì¹˜ë©ë‹ˆë‹¤"

# VSCode ì‘ì—…ê³µê°„ ì„¤ì • ìƒì„± (Isaac Lab python í™˜ê²½ìœ¼ë¡œ ìˆ˜ì •)
RUN tee /AILAB-summer-school-2025/.vscode/settings.json > /dev/null <<'EOF'
{
    "python.defaultInterpreterPath": "/usr/local/bin/python",
    "python.terminal.executeInFileDir": true,
    "python.terminal.activateEnvironment": false,
    "python.analysis.extraPaths": [
        "/opt/IsaacLab/source",
        "/AILAB-summer-school-2025"
    ],
    "python.linting.enabled": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true,
    "terminal.integrated.cwd": "/AILAB-summer-school-2025",
    "editor.fontFamily": "'D2Coding', 'Noto Sans CJK KR', 'Nanum Gothic Coding', 'DejaVu Sans Mono', monospace",
    "editor.fontSize": 14,
    "terminal.integrated.fontFamily": "'D2Coding', 'Noto Sans Mono CJK KR', 'Nanum Gothic Coding', monospace",
    "terminal.integrated.fontSize": 14,
    "jupyter.defaultKernel": "isaaclab-direct"
}
EOF

# Python ë°±ì—… ìƒì„±
RUN cp /usr/bin/python3 /usr/bin/python3-system && \
    cp /usr/bin/python /usr/bin/python-system 2>/dev/null || ln -sf /usr/bin/python3 /usr/bin/python-system

# Isaac Lab Python ë˜í¼ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (v2.1.0 êµ¬ì¡° ë°˜ì˜)
RUN tee /usr/local/bin/python > /dev/null <<'EOF'
#!/bin/bash

# ê¸°ë³¸ ì‹¤í–‰ íŒŒì¼ë“¤
ISAACLAB_PYTHON="/opt/IsaacLab/isaaclab.sh -p"
ISAAC_PYTHON="/isaac-sim/python.sh"
SYSTEM_PYTHON="/usr/bin/python3-system"
CURRENT_DIR="$(pwd)"

# ì•ˆì „í•œ ì‹¤í–‰ í•¨ìˆ˜
safe_exec() {
    local cmd="$1"
    shift
    if command -v "${cmd%% *}" >/dev/null 2>&1; then
        exec $cmd "$@"
    else
        echo "âŒ Command not found: ${cmd%% *}" >&2
        exec "$SYSTEM_PYTHON" "$@"
    fi
}

# í™˜ê²½ ê°ì§€ í•¨ìˆ˜ë“¤
is_vscode_terminal() {
    [[ "$TERM_PROGRAM" == "vscode" ]] || [[ -n "$VSCODE_PID" ]] || [[ -n "$VSCODE_INJECTION" ]]
}

is_isaac_env() {
    [[ "$CURRENT_DIR" =~ ^/AILAB-summer-school-2025 ]] || \
    [[ "$CURRENT_DIR" =~ ^/opt/IsaacLab ]] || \
    [[ "$CURRENT_DIR" == "/AILAB-summer-school-2025" ]] || \
    [[ "$CURRENT_DIR" == "/opt/IsaacLab" ]] || \
    is_vscode_terminal
}

is_isaac_script() {
    local script="$1"
    if [[ -f "$script" ]]; then
        if grep -q "isaac\|isaaclab\|torch\.cuda\|AppLauncher" "$script" 2>/dev/null || \
           [[ "$script" =~ (set_env|grasp_|isaac|check_env) ]]; then
            return 0
        fi
    fi
    return 1
}

# Isaac Lab ê°€ìš©ì„± í™•ì¸ (v2.1.0 êµ¬ì¡° ë°˜ì˜)
is_isaaclab_available() {
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"
    export OMNI_KIT_ALLOW_ROOT=1
    
    if /isaac-sim/python.sh -c "
import sys
sys.path.insert(0, '/opt/IsaacLab/source')
try:
    import isaaclab
    exit(0)
except ImportError:
    exit(1)
" >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

# Isaac Lab í™˜ê²½ ì„¤ì •
setup_isaaclab_env() {
    export ISAACLAB_PATH="/opt/IsaacLab"
    export ISAAC_SIM_PATH="/isaac-sim"
    export OMNI_KIT_ALLOW_ROOT=1 
    export TERM=xterm-256color
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"
    
    # X11 í™˜ê²½ë„ í•¨ê»˜ ì„¤ì •
    [[ -z "$DISPLAY" ]] && export DISPLAY=:0
    export QT_X11_NO_MITSHM=1 
    export QT_GRAPHICSSYSTEM=native
    export LIBGL_ALWAYS_INDIRECT=0 
    export LIBGL_ALWAYS_SOFTWARE=0
    export __GL_SYNC_TO_VBLANK=0 
    export __GL_MaxFramesAllowed=1
    export MESA_GL_VERSION_OVERRIDE=4.1
}

# Isaac Sim ì§ì ‘ ì‹¤í–‰ (Isaac Lab ì—†ì´)
run_with_isaac_sim() {
    export OMNI_KIT_ALLOW_ROOT=1
    export ISAAC_SIM_PATH="/isaac-sim"
    export PYTHONPATH="/isaac-sim/kit/python/lib/python3.10/site-packages"
    [[ -z "$DISPLAY" ]] && export DISPLAY=:0
    export QT_X11_NO_MITSHM=1
    safe_exec "$ISAAC_PYTHON" "$@"
}

# ë©”ì¸ ë¡œì§
case "${1:-}" in
    --version|--help|-V|-h)
        if is_isaaclab_available; then
            setup_isaaclab_env
            safe_exec "$ISAAC_PYTHON" "$@"
        else
            run_with_isaac_sim "$@"
        fi ;;
    -c|-m)
        if [[ "$2" =~ (isaac|isaaclab|torch) ]] || is_isaac_env || is_vscode_terminal; then
            if is_isaaclab_available; then
                setup_isaaclab_env
                safe_exec "$ISAAC_PYTHON" "$@"
            else
                run_with_isaac_sim "$@"
            fi
        else
            safe_exec "$SYSTEM_PYTHON" "$@"
        fi ;;
    "")
        if is_isaac_env || is_vscode_terminal; then
            echo "ğŸš€ Isaac Python (interactive)"
            if is_isaaclab_available; then
                setup_isaaclab_env
                cd /opt/IsaacLab 2>/dev/null || true
                safe_exec "$ISAAC_PYTHON"
            else
                echo "âš ï¸ Isaac Lab not available, using Isaac Sim Python"
                run_with_isaac_sim
            fi
        else
            safe_exec "$SYSTEM_PYTHON"
        fi ;;
    *)
        if is_isaac_env || is_isaac_script "$1" || is_vscode_terminal; then
            echo "ğŸš€ Running with Isaac Python: $1"
            if is_isaaclab_available; then
                echo "  (Isaac Lab environment)"
                setup_isaaclab_env
                safe_exec "$ISAAC_PYTHON" "$@"
            else
                echo "  (Isaac Sim environment)"
                run_with_isaac_sim "$@"
            fi
        else
            safe_exec "$SYSTEM_PYTHON" "$@"
        fi ;;
esac
EOF

# python3ë„ ë™ì¼í•œ ë˜í¼ë¡œ ì„¤ì •
RUN cp /usr/local/bin/python /usr/local/bin/python3 && \
    chmod +x /usr/local/bin/python /usr/local/bin/python3

# Isaac Lab wrapper Python kernel ì¶”ê°€ ë“±ë¡
RUN echo "ğŸ”§ Isaac Lab wrapper kernel ë“±ë¡ ì¤‘..." && \
    export ISAACLAB_PATH="/opt/IsaacLab" && \
    export ISAAC_SIM_PATH="/isaac-sim" && \
    export OMNI_KIT_ALLOW_ROOT=1 && \
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages" && \
    # Isaac Lab wrapper Python kernel ë“±ë¡ (ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©)
    /usr/local/bin/python -m ipykernel install --user --name isaaclab-wrapper --display-name "Isaac Lab Python" && \
    echo "âœ… Isaac Lab wrapper kernel ë“±ë¡ ì™„ë£Œ"

# X11 í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ë“¤ ìƒì„±
RUN tee /usr/local/bin/setup-x11 > /dev/null <<'EOF'
#!/bin/bash
echo "ğŸ”§ X11 í™˜ê²½ ì„¤ì • ì¤‘..."

if [[ -z "$DISPLAY" ]]; then
    export DISPLAY=:0
    echo "ğŸ“º DISPLAY ì„¤ì •: $DISPLAY"
fi

if [[ -n "$XAUTH" ]] && [[ -f "$XAUTH" ]]; then
    export XAUTHORITY="$XAUTH"
    echo "ğŸ” XAUTHORITY ì„¤ì •: $XAUTHORITY"
elif [[ -f "/tmp/.docker.xauth" ]]; then
    export XAUTHORITY="/tmp/.docker.xauth"
    echo "ğŸ” XAUTHORITY ì„¤ì •: $XAUTHORITY"
fi

export QT_X11_NO_MITSHM=1
export QT_GRAPHICSSYSTEM=native
export LIBGL_ALWAYS_INDIRECT=0
export LIBGL_ALWAYS_SOFTWARE=0
export __GL_SYNC_TO_VBLANK=0
export __GL_MaxFramesAllowed=1
export MESA_GL_VERSION_OVERRIDE=4.1

echo "âœ… X11 í™˜ê²½ ì„¤ì • ì™„ë£Œ"

if command -v xdpyinfo >/dev/null 2>&1; then
    if xdpyinfo >/dev/null 2>&1; then
        echo "âœ… X11 ì—°ê²° í…ŒìŠ¤íŠ¸: ì„±ê³µ"
    else
        echo "âŒ X11 ì—°ê²° í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
        echo "ğŸ’¡ ë„ì»¤ ì‹¤í–‰ ì‹œ ë‹¤ìŒ ì˜µì…˜ë“¤ì´ í•„ìš”í•©ë‹ˆë‹¤:"
        echo "   -e DISPLAY=\$DISPLAY"
        echo "   -v /tmp/.X11-unix:/tmp/.X11-unix:rw"
        echo "   -v \$XAUTH:/tmp/.docker.xauth:rw"
        echo "   --network=host"
    fi
else
    echo "âš ï¸ xdpyinfo ì—†ìŒ - X11 ì—°ê²° í™•ì¸ ë¶ˆê°€"
fi
EOF

# ì•ˆì „í•œ VSCode ì‹¤í–‰ê¸°
RUN tee /usr/local/bin/code-safe > /dev/null <<'EOF'
#!/bin/bash
echo "ğŸš€ VSCode ì‹œì‘ (X11 í™˜ê²½ ì„¤ì • í¬í•¨)..."

source /usr/local/bin/setup-x11

VSCODE_USER_DATA_DIR="/root/.vscode"
mkdir -p "$VSCODE_USER_DATA_DIR"

if [ $# -eq 0 ]; then
    if [[ "$PWD" =~ ^/AILAB-summer-school-2025 ]] || [[ "$PWD" == "/AILAB-summer-school-2025" ]]; then
        TARGET="."
    else
        TARGET="/AILAB-summer-school-2025"
        echo "ğŸ“ /AILAB-summer-school-2025ë¡œ ì´ë™í•©ë‹ˆë‹¤."
        cd /AILAB-summer-school-2025
    fi
else
    TARGET="$@"
fi

echo "ğŸ“‚ VSCode ì‹¤í–‰: $TARGET"

exec /usr/bin/code \
    --no-sandbox \
    --disable-gpu-sandbox \
    --disable-software-rasterizer \
    --user-data-dir="$VSCODE_USER_DATA_DIR" \
    --extensions-dir="$VSCODE_USER_DATA_DIR/extensions" \
    "$TARGET"
EOF

# ì¶”ê°€ í¸ì˜ ìŠ¤í¬ë¦½íŠ¸ë“¤
RUN tee /usr/local/bin/vs > /dev/null <<'EOF'
#!/bin/bash
exec code-safe "$@"
EOF

RUN tee /usr/local/bin/isaac-vscode > /dev/null <<'EOF'
#!/bin/bash
echo "ğŸš€ Isaac Lab VSCode ì‹œì‘..."
source /usr/local/bin/setup-x11
mkdir -p /root/.vscode
cd /AILAB-summer-school-2025
exec code-safe .
EOF

# ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /usr/local/bin/setup-x11 /usr/local/bin/code-safe /usr/local/bin/vs /usr/local/bin/isaac-vscode

# bash ì„¤ì • ì¶”ê°€ (v2.1.0 êµ¬ì¡° ë°˜ì˜ + dependency ì •ë³´ ì¶”ê°€)
RUN tee -a /root/.bashrc > /dev/null <<'EOF'

# === Isaac Lab Environment Setup ===
export ISAAC_SIM_PATH="/isaac-sim"
export ISAACLAB_PATH="/opt/IsaacLab"
export PYTHONPATH="/isaac-sim/kit/python/lib/python3.10/site-packages:/opt/IsaacLab/source:${PYTHONPATH}"
export OMNI_KIT_ALLOW_ROOT=1

setup_gui_environment() {
    if [[ -z "$DISPLAY" ]]; then
        export DISPLAY=:0
    fi
    
    export QT_X11_NO_MITSHM=1
    export QT_GRAPHICSSYSTEM=native
    export LIBGL_ALWAYS_INDIRECT=0
    export LIBGL_ALWAYS_SOFTWARE=0
    export __GL_SYNC_TO_VBLANK=0
    export __GL_MaxFramesAllowed=1
    export MESA_GL_VERSION_OVERRIDE=4.1
    export OMNI_KIT_ALLOW_ROOT=1
    
    if [[ -n "$XAUTH" ]] && [[ -f "$XAUTH" ]]; then
        export XAUTHORITY="$XAUTH"
    elif [[ -f "/tmp/.docker.xauth" ]]; then
        export XAUTHORITY="/tmp/.docker.xauth"
    fi
}

setup_gui_environment

alias code='code-safe'
alias vs='code-safe'
alias vscode='cd /AILAB-summer-school-2025 && code-safe .'
alias code-AILAB-summer-school-2025='cd /AILAB-summer-school-2025 && code-safe .'
alias code-here='code-safe .'
alias isaacsim='${ISAAC_SIM_PATH}/isaac-sim.sh'

code-isaac() {
    echo "ğŸš€ Isaac Lab VSCode ì‹œì‘..."
    cd /AILAB-summer-school-2025
    code-safe .
}

code-lab() {
    echo "ğŸ”¬ Isaac Lab ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ì—ì„œ VSCode ì‹œì‘..."
    cd /opt/IsaacLab  
    code-safe .
}

code-new() {
    if [ -n "$1" ]; then
        mkdir -p "$1" && cd "$1" && code-safe .
    else
        echo "ì‚¬ìš©ë²•: code-new <ë””ë ‰í† ë¦¬ëª…>"
    fi
}

run-isaac-gui() {
    echo "ğŸš€ Running Isaac Sim with enhanced GUI support: $@"
    setup_gui_environment
    /isaac-sim/python.sh "$@"
}

run-isaac-headless() {
    echo "ğŸ¤– Running Isaac Sim in headless mode: $@"
    export ISAAC_HEADLESS=1
    /isaac-sim/python.sh "$@"
}

debug-x11() {
    echo "ğŸ” X11 í™˜ê²½ ë””ë²„ê·¸ ì •ë³´:"
    echo "  DISPLAY: $DISPLAY"
    echo "  XAUTHORITY: $XAUTHORITY"
    echo "  QT_X11_NO_MITSHM: $QT_X11_NO_MITSHM"
    echo "  LIBGL_ALWAYS_INDIRECT: $LIBGL_ALWAYS_INDIRECT"
    echo ""
    
    if command -v xdpyinfo >/dev/null 2>&1; then
        if xdpyinfo >/dev/null 2>&1; then
            echo "âœ… X11 ì„œë²„ ì—°ê²°: ì„±ê³µ"
            echo "ğŸ–¥ï¸ ë””ìŠ¤í”Œë ˆì´ ì •ë³´:"
            xdpyinfo | head -10
        else
            echo "âŒ X11 ì„œë²„ ì—°ê²°: ì‹¤íŒ¨"
        fi
    else
        echo "âš ï¸ xdpyinfo ëª…ë ¹ì–´ ì—†ìŒ"
    fi
    
    echo ""
    if command -v glxinfo >/dev/null 2>&1; then
        echo "ğŸ® OpenGL ì •ë³´:"
        glxinfo | grep -E "(OpenGL vendor|OpenGL renderer|OpenGL version)" || echo "OpenGL ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
    else
        echo "âš ï¸ glxinfo ëª…ë ¹ì–´ ì—†ìŒ"
    fi
}

show-code-help() {
    echo ""
    echo "ğŸ¯ === Isaac Lab VSCode ëª…ë ¹ì–´ ê°€ì´ë“œ ==="
    echo "ğŸ“ ê¸°ë³¸ ì‚¬ìš©ë²•:"
    echo "  code              # ì•ˆì „í•œ ì˜µì…˜ìœ¼ë¡œ VSCode ì‹¤í–‰"
    echo "  code .            # í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ VSCode ì—´ê¸°"
    echo "  code <ê²½ë¡œ>       # íŠ¹ì • ê²½ë¡œì—ì„œ VSCode ì—´ê¸°"
    echo ""
    echo "ğŸš€ í¸ì˜ ëª…ë ¹ì–´:"
    echo "  vs                # codeì˜ ì§§ì€ ë³„ëª…"
    echo "  vscode            # /AILAB-summer-school-2025ì—ì„œ VSCode ì‹œì‘"
    echo "  code-isaac        # /AILAB-summer-school-2025ì—ì„œ VSCode ì‹œì‘ (í•¨ìˆ˜)"
    echo "  code-lab          # /opt/IsaacLabì—ì„œ VSCode ì‹œì‘"
    echo "  code-here         # í˜„ì¬ ìœ„ì¹˜ì—ì„œ VSCode ì‹œì‘"
    echo "  code-AILAB-summer-school-2025    # /AILAB-summer-school-2025ë¡œ ì´ë™ í›„ VSCode ì‹œì‘"
    echo ""
    echo "ğŸ® Isaac Sim GUI:"
    echo "  python script.py  # ìë™ìœ¼ë¡œ Isaac Sim Python ì‚¬ìš©"
    echo "  run-isaac-gui <script>  # GUI í™˜ê²½ ê°•ì œ ì„¤ì •"
    echo "  run-isaac-headless <script>  # Headless ëª¨ë“œë¡œ ì‹¤í–‰"
    echo ""
    echo "ğŸ”§ ë””ë²„ê·¸ ë„êµ¬:"
    echo "  debug-x11         # X11 í™˜ê²½ ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ"
    echo "  setup-x11         # X11 í™˜ê²½ ìˆ˜ë™ ì„¤ì •"
    echo ""
}

run-isaac() {
    setup_gui_environment
    /isaac-sim/python.sh "$@"
}

debug-isaac() {
    echo "ğŸ” Isaac Lab Python í™˜ê²½:"
    echo "  Default Python: /usr/local/bin/python (Isaac Lab wrapper)"
    echo "  Isaac Lab Script: /opt/IsaacLab/isaaclab.sh"
    echo "  Isaac Sim Python: /isaac-sim/python.sh"
    echo "  PYTHONPATH: $PYTHONPATH"
    echo "  ISAACLAB_PATH: $ISAACLAB_PATH"
    echo "  DISPLAY: $DISPLAY"
    echo "  XAUTHORITY: $XAUTHORITY"
    echo ""
    echo "ğŸ§ª Testing Python environments:"
    
    echo "  1. Default python (should be Isaac Lab):"
    python --version 2>/dev/null || echo "    Python ì‹¤í–‰ ì‹¤íŒ¨"
    
    echo "  2. Isaac Lab python test:"
    setup_gui_environment
    if [ -f "/opt/IsaacLab/isaaclab.sh" ]; then
        /opt/IsaacLab/isaaclab.sh -p -c "import sys; print(f'    Isaac Lab Python: {sys.executable}')" 2>/dev/null || echo "    Isaac Lab Python í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    else
        echo "    Isaac Lab ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ"
    fi
    
    echo "  3. Direct Isaac Sim python test:"
    /isaac-sim/python.sh -c "import sys; print(f'    Isaac Sim Python: {sys.executable}')" 2>/dev/null || echo "    Isaac Sim Python í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    
    echo "  4. Isaac Lab module test (v2.1.0):"
    if /usr/local/bin/test-isaaclab >/dev/null 2>&1; then
        echo "    âœ… Isaac Lab module: Available"
    else
        echo "    âŒ Isaac Lab module: Not available"
        echo "    ğŸ’¡ Fix: run 'fix-isaaclab'"
    fi
    
    if [ -n "$1" ]; then
        echo ""
        echo "ğŸš€ Running script with Isaac Lab Python: $1"
        setup_gui_environment
        if [ -f "/opt/IsaacLab/isaaclab.sh" ]; then
            /opt/IsaacLab/isaaclab.sh -p "$@"
        else
            echo "Isaac Lab ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
    fi
}

# Python í™˜ê²½ í™•ì¸ í•¨ìˆ˜ (dependency ì •ë³´ ì¶”ê°€)
check-python-env() {
    echo "ğŸ Python í™˜ê²½ í™•ì¸ (í˜¸í™˜ì„± ë²„ì „ í¬í•¨):"
    echo ""
    echo "1. ê¸°ë³¸ python ëª…ë ¹ì–´:"
    echo "   $(which python) -> $(readlink -f $(which python) 2>/dev/null || echo 'direct execution')"
    echo ""
    echo "2. python ì‹¤í–‰ í…ŒìŠ¤íŠ¸:"
    
    # Python í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ìƒì„±
    cat > /tmp/check_python_env.py << 'PYEOF'
import sys
print(f'   Python executable: {sys.executable}')
print(f'   Python version: {sys.version.split()[0]}')

# Isaac Lab ê´€ë ¨ íŒ¨í‚¤ì§€ í…ŒìŠ¤íŠ¸
try:
    import isaaclab
    print('   âœ… Isaac Lab íŒ¨í‚¤ì§€: Available')
    
    # ê°€ì¥ ì¤‘ìš”í•œ AppLauncher í…ŒìŠ¤íŠ¸
    try:
        from isaaclab.app import AppLauncher
        print('   âœ… isaaclab.app.AppLauncher: Available')
    except ImportError as e:
        print(f'   âŒ isaaclab.app.AppLauncher: Not available - {e}')
        
except ImportError:
    print('   âŒ Isaac Lab íŒ¨í‚¤ì§€: Not available')

# ì£¼ìš” dependencyë“¤ ë²„ì „ í™•ì¸
packages_to_check = [
    ('torch', 'PyTorch'), ('numpy', 'NumPy'), ('opencv-python', 'OpenCV'), 
    ('gymnasium', 'Gymnasium'), ('psutil', 'psutil'), ('lxml', 'lxml'),
    ('toml', 'TOML'), ('pytz', 'pytz'), ('ipykernel', 'IPython Kernel')
]

print('   ğŸ“¦ ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „:')
for package, display_name in packages_to_check:
    try:
        if package == 'opencv-python':
            module = __import__('cv2')
        else:
            module = __import__(package.replace('-', '_'))
        version = getattr(module, '__version__', 'Unknown')
        
        # CUDA ì§€ì› í™•ì¸ (PyTorch)
        if package == 'torch':
            cuda_available = module.cuda.is_available()
            print(f'     âœ… {display_name}: {version} (CUDA: {cuda_available})')
        else:
            print(f'     âœ… {display_name}: {version}')
    except ImportError:
        print(f'     âŒ {display_name}: Not available')

# í˜¸í™˜ì„± ì²´í¬
print('   ğŸ” í˜¸í™˜ì„± ì²´í¬:')
try:
    import numpy, cv2
    print(f'     âœ… numpy ({numpy.__version__}) + opencv í˜¸í™˜')
except:
    print('     âŒ numpy + opencv í˜¸í™˜ì„± ë¬¸ì œ')

try:
    import psutil
    print(f'     âœ… psutil ({psutil.__version__}) - rl-games í˜¸í™˜')
except:
    print('     âŒ psutil ë¬¸ì œ')

try:
    import gymnasium
    print(f'     âœ… gymnasium ({gymnasium.__version__}) - stable-baselines3 í˜¸í™˜')
except:
    print('     âŒ gymnasium ë¬¸ì œ')
PYEOF

    # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    python /tmp/check_python_env.py
    
    # ì„ì‹œ íŒŒì¼ ì •ë¦¬
    rm -f /tmp/check_python_env.py
    
    echo ""
    echo "3. Isaac Lab ìŠ¤í¬ë¦½íŠ¸ í…ŒìŠ¤íŠ¸:"
    if [ -f "/opt/IsaacLab/isaaclab.sh" ]; then
        echo "   âœ… Isaac Lab script: Available"
        echo "   ì‚¬ìš©ë²•: isaaclab -s (simulation), isaaclab -p script.py (run script)"
    else
        echo "   âŒ Isaac Lab script: Missing"
    fi
    echo ""
    echo "4. ì „ì²´ Isaac Lab í™˜ê²½ í…ŒìŠ¤íŠ¸:"
    if /usr/local/bin/test-isaaclab >/dev/null 2>&1; then
        echo "   âœ… Isaac Lab ì™„ì „ ì„¤ì¹˜: ì„±ê³µ"
    else
        echo "   âŒ Isaac Lab ì™„ì „ ì„¤ì¹˜: ì‹¤íŒ¨ - fix-isaaclab ëª…ë ¹ì–´ë¡œ ìˆ˜ì • ê°€ëŠ¥"
    fi
}

# Isaac Lab í¸ì˜ í•¨ìˆ˜ë“¤ (ì•ˆì „í•œ ë²„ì „)
isaaclab-sim() {
    echo "ğŸš€ Isaac Lab ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘..."
    cd /opt/IsaacLab
    setup_gui_environment
    if [ -f "./isaaclab.sh" ]; then
        ./isaaclab.sh -s
    else
        echo "âŒ Isaac Lab ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        echo "ğŸ’¡ Fix: run 'fix-isaaclab'"
    fi
}

isaaclab-help() {
    echo "ğŸ¯ Isaac Lab ëª…ë ¹ì–´ ê°€ì´ë“œ:"
    echo "  isaaclab -s         # Isaac Lab ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘"
    echo "  isaaclab -p <script> # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
    echo "  isaaclab-sim        # GUIë¡œ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘"
    echo "  isaaclab --help     # ì „ì²´ ì˜µì…˜ ë³´ê¸°"
    echo ""
    echo "ğŸ“‚ Isaac Lab ë””ë ‰í† ë¦¬ë¡œ ì´ë™: cd /opt/IsaacLab"
    echo "ğŸ”§ Isaac Lab ì¬ì„¤ì¹˜: cd /opt/IsaacLab && ./isaaclab.sh --install"
}

# Isaac Lab í™˜ê²½ìœ¼ë¡œ ì´ë™
cdlab() {
    cd /opt/IsaacLab
    echo "ğŸ“‚ Isaac Lab ë””ë ‰í† ë¦¬: $(pwd)"
    echo "ğŸš€ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: isaaclab -s, isaaclab-sim"
}

# Isaac Lab ì¬ì„¤ì¹˜ í•¨ìˆ˜ (ì •ì‹ ì„¤ì¹˜ ë°©ë²• + dependency ê³ ë ¤)
fix-isaaclab() {
    echo "ğŸ”§ Isaac Lab í™˜ê²½ ì¬ì„¤ì • ì¤‘ (í˜¸í™˜ì„± ë²„ì „ í¬í•¨)..."
    cd /opt/IsaacLab
    
    echo "ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •..."
    export ISAACLAB_PATH="/opt/IsaacLab"
    export ISAAC_SIM_PATH="/isaac-sim"
    export OMNI_KIT_ALLOW_ROOT=1 TERM=xterm-256color
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"
    
    echo "ğŸ“¦ ì£¼ìš” dependency ì¬ì„¤ì¹˜ (í˜¸í™˜ì„± ë²„ì „)..."
    /isaac-sim/python.sh -m pip install --no-cache-dir --force-reinstall \
        gymnasium==0.29.1 toml lxml==5.2.2 pytz>=2020.1 \
        opencv-python==4.8.1.78 psutil==5.9.8 ipykernel
    
    echo "ğŸ”„ Isaac Lab ì •ì‹ ì¬ì„¤ì¹˜..."
    # ê¸°ì¡´ ì„¤ì¹˜ ì œê±°
    /isaac-sim/python.sh -m pip uninstall -y isaaclab 2>/dev/null || true
    
    # ì •ì‹ ì¬ì„¤ì¹˜
    if /isaac-sim/python.sh -m pip install --no-cache-dir -e . --force-reinstall; then
        echo "âœ… Isaac Lab ì¬ì„¤ì¹˜ ì„±ê³µ!"
    else
        echo "âŒ Isaac Lab ì¬ì„¤ì¹˜ ì‹¤íŒ¨"
        echo "ğŸ”§ ëŒ€ì•ˆ ë°©ë²• ì‹œë„ ì¤‘..."
        
        # ëŒ€ì•ˆ: Isaac Lab ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©
        if [ -f "./isaaclab.sh" ]; then
            echo "ğŸ“¦ isaaclab.sh --install ì‹¤í–‰..."
            chmod +x ./isaaclab.sh
            ./isaaclab.sh --install || echo "isaaclab.sh --install ì‹¤íŒ¨"
        fi
    fi
    
    echo "ğŸ”— isaaclab ëª…ë ¹ì–´ ì¬ìƒì„±..."
    chmod +x ./isaaclab.sh 2>/dev/null || true
    rm -f /usr/local/bin/isaaclab
    ln -sf /opt/IsaacLab/isaaclab.sh /usr/local/bin/isaaclab
    
    echo "ğŸ““ Jupyter kernel ì¬ë“±ë¡..."
    /isaac-sim/python.sh -m ipykernel install --user --name isaaclab-direct --display-name "Isaac Lab Direct" --force
    if command -v /usr/local/bin/python >/dev/null 2>&1; then
        /usr/local/bin/python -m ipykernel install --user --name isaaclab-wrapper --display-name "Isaac Lab Python" --force
    fi
    
    echo "ğŸ§ª Isaac Lab í™˜ê²½ í…ŒìŠ¤íŠ¸..."
    
    # Python í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ìƒì„±
    cat > /tmp/fix_isaaclab_test.py << 'PYEOF'
import isaaclab
from isaaclab.app import AppLauncher
print('âœ… Isaac Lab ì™„ì „ ì„¤ì¹˜ í™•ì¸!')

# Dependency ì²´í¬ë„ í•¨ê»˜
import numpy, cv2, gymnasium, psutil
print(f'âœ… Dependency ì²´í¬: numpy {numpy.__version__}, opencv {cv2.__version__}')
print(f'âœ… í˜¸í™˜ì„± ì²´í¬: gymnasium {gymnasium.__version__}, psutil {psutil.__version__}')
PYEOF

    if /isaac-sim/python.sh /tmp/fix_isaaclab_test.py 2>/dev/null; then
        echo "âœ… Isaac Lab í™˜ê²½ ì¬ì„¤ì • ì™„ë£Œ! (í˜¸í™˜ì„± ë²„ì „ í¬í•¨)"
        echo ""
        echo "ğŸš€ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
        echo "  isaaclab -s              # ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘"
        echo "  isaaclab -p script.py    # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"  
        echo "  python script.py         # ìë™ìœ¼ë¡œ Isaac Lab í™˜ê²½ ì‚¬ìš©"
        echo "  check-python-env         # ì „ì²´ í™˜ê²½ ë° dependency í™•ì¸"
        echo ""
    else
        echo "âš ï¸ Isaac Lab í™˜ê²½ ì„¤ì • ì—¬ì „íˆ ì‹¤íŒ¨"
        echo ""
        echo "ğŸ› ï¸ ìˆ˜ë™ í•´ê²° ë°©ë²•:"
        echo "1. cd /opt/IsaacLab"
        echo "2. /isaac-sim/python.sh -m pip install -e . --force-reinstall"
        echo "3. ë˜ëŠ” ./isaaclab.sh --install"
        echo ""
        
        # ì§„ë‹¨ ì •ë³´ ì œê³µ
        echo "ğŸ” ì§„ë‹¨ ì •ë³´:"
        cat > /tmp/diagnose_isaaclab.py << 'PYEOF'
try:
    import isaaclab
    import os
    isaaclab_path = os.path.dirname(isaaclab.__file__)
    print(f'ğŸ“‚ isaaclab ì„¤ì¹˜ ê²½ë¡œ: {isaaclab_path}')
    items = [item for item in os.listdir(isaaclab_path) if not item.startswith('__')]
    print(f'ğŸ“¦ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“ˆë“¤: {items}')
except ImportError as e:
    print(f'âŒ isaaclab import ì‹¤íŒ¨: {e}')
PYEOF
        /isaac-sim/python.sh /tmp/diagnose_isaaclab.py 2>/dev/null || echo "ì§„ë‹¨ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
        rm -f /tmp/diagnose_isaaclab.py
    fi
    
    # ì„ì‹œ íŒŒì¼ ì •ë¦¬
    rm -f /tmp/fix_isaaclab_test.py
    
    source ~/.bashrc
}

# ë³„ì¹­ ì¶”ê°€
alias reinstall-isaaclab='fix-isaaclab'
EOF

# SSH ì„¤ì •
RUN mkdir -p /var/run/sshd && \
    echo 'root:isaac123' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (v2.1.0 êµ¬ì¡° ë°˜ì˜ + dependency ì •ë³´ ì¶”ê°€)
RUN tee /startup.sh > /dev/null <<'EOF'
#!/bin/bash

echo "======================================"
echo "ğŸš€ Isaac Lab Environment Starting..."
echo "======================================"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
export ISAAC_SIM_PATH="/isaac-sim"
export ISAACLAB_PATH="/opt/IsaacLab"
export PYTHONPATH="/isaac-sim/kit/python/lib/python3.10/site-packages:/opt/IsaacLab/source"
export OMNI_KIT_ALLOW_ROOT=1

# X11 í™˜ê²½ ìë™ ì„¤ì •
[[ -z "$DISPLAY" ]] && export DISPLAY=:0
export QT_X11_NO_MITSHM=1
export QT_GRAPHICSSYSTEM=native
export LIBGL_ALWAYS_INDIRECT=0
export LIBGL_ALWAYS_SOFTWARE=0
export __GL_SYNC_TO_VBLANK=0
export __GL_MaxFramesAllowed=1
export MESA_GL_VERSION_OVERRIDE=4.1

echo "ğŸ”§ X11 í™˜ê²½ ì„¤ì • ì¤‘..."
if [[ -n "$XAUTH" ]] && [[ -f "$XAUTH" ]]; then
    export XAUTHORITY="$XAUTH"
elif [[ -f "/tmp/.docker.xauth" ]]; then
    export XAUTHORITY="/tmp/.docker.xauth"
fi
echo "âœ… X11 í™˜ê²½ ì„¤ì • ì™„ë£Œ"

# X11 ì—°ê²° í…ŒìŠ¤íŠ¸
if command -v xdpyinfo >/dev/null 2>&1; then
    if xdpyinfo >/dev/null 2>&1; then
        echo "âœ… X11 ì—°ê²° í…ŒìŠ¤íŠ¸: ì„±ê³µ"
    else
        echo "âŒ X11 ì—°ê²° í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
        echo "ğŸ’¡ Docker ì‹¤í–‰ ì‹œ X11 ì˜µì…˜ í™•ì¸ í•„ìš”"
    fi
fi

cd /opt/IsaacLab

echo "ğŸ§ª Testing installations..."

echo "ğŸ“‹ Python Environment Check:"
echo "  Default python: $(which python)"
echo "  Python wrapper: $(readlink -f $(which python) 2>/dev/null || echo 'direct execution')"

# ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „ ì²´í¬ (dependency í¬í•¨)
echo "ğŸ“¦ í˜¸í™˜ì„± íŒ¨í‚¤ì§€ ë²„ì „ ì²´í¬:"
cat > /tmp/startup_dependency_check.py << 'PYEOF'
packages = [
    ('torch', 'PyTorch'), ('numpy', 'NumPy'), ('opencv-python', 'OpenCV'), 
    ('gymnasium', 'Gymnasium'), ('psutil', 'psutil'), ('lxml', 'lxml'),
    ('toml', 'TOML'), ('pytz', 'pytz'), ('ipykernel', 'IPython Kernel')
]

for package, display_name in packages:
    try:
        if package == 'opencv-python':
            module = __import__('cv2')
        else:
            module = __import__(package.replace('-', '_'))
        version = getattr(module, '__version__', 'Unknown')
        
        if package == 'torch':
            cuda_available = module.cuda.is_available()
            print(f'  âœ… {display_name}: {version} (CUDA: {cuda_available})')
        else:
            print(f'  âœ… {display_name}: {version}')
    except ImportError:
        print(f'  âŒ {display_name}: Not installed')
PYEOF

if python /tmp/startup_dependency_check.py; then
    echo "âœ… í˜¸í™˜ì„± íŒ¨í‚¤ì§€ë“¤: OK"
else
    echo "âŒ ì¼ë¶€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì´ìŠˆ"
fi
rm -f /tmp/startup_dependency_check.py

if /isaac-sim/python.sh -c "import omni.isaac.kit; print('Isaac Sim: OK')"; then
    echo "âœ… Isaac Sim: OK"
else
    echo "âŒ Isaac Sim import issue"
fi

# Isaac Lab í…ŒìŠ¤íŠ¸ (ì •ì‹ ì„¤ì¹˜ ê²€ì¦)
echo "ğŸ”¬ Testing Isaac Lab (ì •ì‹ ì„¤ì¹˜ ê²€ì¦)..."
echo "ğŸ“‚ Isaac Lab êµ¬ì¡° í™•ì¸:"
if [ -d "/opt/IsaacLab/source/isaaclab" ]; then
    echo "  âœ… isaaclab íŒ¨í‚¤ì§€: ì¡´ì¬"
    ls -la /opt/IsaacLab/source/ | grep isaaclab
else
    echo "  âŒ isaaclab íŒ¨í‚¤ì§€: ì—†ìŒ"
fi

# Python í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ìƒì„±
cat > /tmp/startup_test_isaaclab.py << 'PYEOF'
import sys
try:
    import isaaclab
    print('âœ… isaaclab íŒ¨í‚¤ì§€ import: ì„±ê³µ')
    
    # ê°€ì¥ ì¤‘ìš”í•œ AppLauncher í…ŒìŠ¤íŠ¸
    try:
        from isaaclab.app import AppLauncher
        print('âœ… isaaclab.app.AppLauncher import: ì„±ê³µ')
        print('âœ… Isaac Lab ì™„ì „ ì„¤ì¹˜ í™•ì¸!')
    except ImportError as e:
        print(f'âŒ isaaclab.app.AppLauncher import ì‹¤íŒ¨: {e}')
        
        # êµ¬ì¡° ì§„ë‹¨
        import os
        isaaclab_path = os.path.dirname(isaaclab.__file__)
        print(f'ğŸ“‚ isaaclab ì„¤ì¹˜ ê²½ë¡œ: {isaaclab_path}')
        items = [item for item in os.listdir(isaaclab_path) if not item.startswith('__')]
        print(f'ğŸ“¦ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“ˆë“¤: {items}')
        exit(1)
        
except ImportError as e:
    print(f'âŒ isaaclab íŒ¨í‚¤ì§€ import ì‹¤íŒ¨: {e}')
    exit(1)
PYEOF

if /isaac-sim/python.sh /tmp/startup_test_isaaclab.py; then
    echo "âœ… Isaac Lab environment ready!"
else
    echo "âŒ Isaac Lab import failed"
    echo "ğŸ”§ Attempting automatic fix..."
    
    # ì •ì‹ ì¬ì„¤ì¹˜ ì‹œë„
    cd /opt/IsaacLab
    echo "ğŸ”„ Isaac Lab ì¬ì„¤ì¹˜ ì¤‘..."
    /isaac-sim/python.sh -m pip install --no-cache-dir -e . --force-reinstall
    
    # ì¬í…ŒìŠ¤íŠ¸
    if /isaac-sim/python.sh /tmp/startup_test_isaaclab.py; then
        echo "âœ… Isaac Lab ìë™ ìˆ˜ì • ì„±ê³µ!"
    else
        echo "âš ï¸ Isaac Lab ìˆ˜ë™ ìˆ˜ì • í•„ìš” - 'fix-isaaclab' ëª…ë ¹ì–´ ì‚¬ìš©"
    fi
fi

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f /tmp/startup_test_isaaclab.py

echo "ğŸ”§ Checking Isaac Lab commands..."
if command -v isaaclab >/dev/null 2>&1; then
    echo "âœ… isaaclab command: Available"
    echo "  Try: isaaclab --help, isaaclab -s (for simulation)"
else
    echo "âŒ isaaclab command: Not found"
    echo "ğŸ”§ Fixing isaaclab command link..."
    cd /opt/IsaacLab
    chmod +x ./isaaclab.sh
    rm -f /usr/local/bin/isaaclab
    ln -sf /opt/IsaacLab/isaaclab.sh /usr/local/bin/isaaclab
    
    if command -v isaaclab >/dev/null 2>&1; then
        echo "âœ… isaaclab command: Fixed!"
    else
        echo "âš ï¸ isaaclab command: Still not working"
        echo "  Alternative: cd /opt/IsaacLab && ./isaaclab.sh -s"
    fi
fi

echo "ğŸ”§ Checking VSCode extensions..."
extension_count=$(code --list-extensions --user-data-dir=/root/.vscode 2>/dev/null | wc -l || echo "0")
echo "ğŸ“¦ VSCode extensions installed: $extension_count"

echo "ğŸ““ Checking Jupyter kernels..."
kernel_count=$(jupyter kernelspec list 2>/dev/null | grep -c "isaac" || echo "0")
if [ "$kernel_count" -gt 0 ]; then
    echo "âœ… Jupyter Isaac Lab kernels: $kernel_count installed"
else
    echo "âš ï¸ Jupyter Isaac Lab kernels: Not found"
    echo "ğŸ”§ Registering kernels..."
    export PYTHONPATH="/opt/IsaacLab/source:/isaac-sim/kit/python/lib/python3.10/site-packages"
    /isaac-sim/python.sh -m ipykernel install --user --name isaaclab-direct --display-name "Isaac Lab Direct" 2>/dev/null || echo "direct kernel registration failed"
    if command -v /usr/local/bin/python >/dev/null 2>&1; then
        /usr/local/bin/python -m ipykernel install --user --name isaaclab-wrapper --display-name "Isaac Lab Python" 2>/dev/null || echo "wrapper kernel registration failed"
    fi
fi

cd /AILAB-summer-school-2025

echo ""
echo "======================================"
echo "ğŸ‰ Isaac Lab Environment Ready!"
echo "======================================"
echo "ğŸ“ Project files: /AILAB-summer-school-2025"
echo "ğŸ”¬ Isaac Lab: /opt/IsaacLab"
echo "ğŸ¤– Isaac Sim: /isaac-sim"
echo "ğŸ‘¤ User: $(whoami)"
echo "ğŸ Isaac Sim Python: /isaac-sim/python.sh"
echo "ğŸ System Python: $(which python3)"
echo "ğŸ’» Safe VSCode: code-safe"
echo "ğŸ”¥ PyTorch: 2.5.1+cu118"
echo "ğŸ–¥ï¸ Display: $DISPLAY"
echo "ğŸ“¦ Compatibility: numpy 1.26.2, opencv 4.8.1, gymnasium 0.29.1"
echo "======================================"
echo ""
echo "ğŸš€ Quick commands:"
echo "  python              # Isaac Lab Python (ìë™ í™˜ê²½ ê°ì§€)"
echo "  isaaclab --help     # Isaac Lab ë„ì›€ë§"
echo "  isaaclab -s         # Isaac Lab ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘"
echo "  isaaclab -p script.py # Isaac Lab Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
echo "  code .              # Open VSCode (ì•ˆì „í•œ ì˜µì…˜ ì ìš©)"
echo "  vs                  # VSCode ì§§ì€ ëª…ë ¹ì–´"
echo "  code-isaac          # /AILAB-summer-school-2025ì—ì„œ VSCode ì‹œì‘"
echo "  isaac-vscode        # Isaac Lab ì „ìš© VSCode"
echo "  isaaclab-sim        # Isaac Lab GUI ì‹œë®¬ë ˆì´ì…˜"
echo "  cdlab               # Isaac Lab ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
echo "  check-python-env    # Python í™˜ê²½ ìƒíƒœ í™•ì¸ (dependency í¬í•¨)"
echo "  fix-isaaclab        # Isaac Lab ì¬ì„¤ì¹˜ (í˜¸í™˜ì„± ë²„ì „ í¬í•¨)"
echo "  run-isaac <script>  # Isaac Sim Pythonìœ¼ë¡œ ì‹¤í–‰"
echo "  run-isaac-gui <script>  # GUI í™˜ê²½ ê°•ì œ ì„¤ì •"
echo "  run-isaac-headless <script>  # Headless ëª¨ë“œë¡œ ì‹¤í–‰"
echo "  debug-x11           # X11 í™˜ê²½ ë””ë²„ê·¸"
echo "  show-code-help      # VSCode ëª…ë ¹ì–´ ì „ì²´ ê°€ì´ë“œ"
echo "  isaaclab-help       # Isaac Lab ëª…ë ¹ì–´ ê°€ì´ë“œ"
echo "  debug-isaac <script>  # ë””ë²„ê·¸ ì •ë³´ì™€ í•¨ê»˜ ì‹¤í–‰"
echo "======================================"
echo ""
echo "ğŸ”§ Isaac Lab ìƒíƒœ:"
if /usr/local/bin/test-isaaclab >/dev/null 2>&1; then
    echo "  âœ… Isaac Lab: ì‚¬ìš© ê°€ëŠ¥"
else
    echo "  âš ï¸ Isaac Lab: fix-isaaclab ëª…ë ¹ì–´ë¡œ ìˆ˜ì • ê°€ëŠ¥"
fi

echo "======================================"
echo ""
echo "ğŸ”¤ í•œê¸€ í™˜ê²½: $(echo 'ì•ˆë…•í•˜ì„¸ìš”!' | head -c 15)..."
echo ""

if [ "$1" = "ssh" ]; then
    service ssh start
    echo "ğŸ”‘ SSH server started on port 22"
    tail -f /dev/null
elif [ "$1" = "vscode" ]; then
    echo "ğŸ¯ Starting VSCode..."
    exec isaac-vscode
elif [ $# -eq 0 ]; then
    echo "ğŸ¯ Starting interactive bash shell..."
    exec /bin/bash
else
    echo "ğŸš€ Executing: $@"
    exec "$@"
fi
EOF

RUN chmod +x /startup.sh

# í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬ (ê°€ì¥ ë§ˆì§€ë§‰ì— - ìºì‹œ ìµœì í™”)
COPY . /AILAB-summer-school-2025/

# ë³µì‚¬ëœ íŒŒì¼ë“¤ ì²˜ë¦¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
RUN chmod -R 755 /AILAB-summer-school-2025 && \
    chown -R root:root /AILAB-summer-school-2025 && \
    # graspnetAPI ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
    if [ -d "/AILAB-summer-school-2025/graspnetAPI" ]; then \
        echo "ğŸ”§ Installing graspnetAPI..."; \
        cd /AILAB-summer-school-2025/graspnetAPI && \
        /isaac-sim/python.sh -m pip install --no-cache-dir -e . && \
        echo "âœ… graspnetAPI installation completed"; \
    fi && \
    # cgnet ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
    if [ -d "/AILAB-summer-school-2025/cgnet" ]; then \
        echo "ğŸ”§ Installing cgnet..."; \
        cd /AILAB-summer-school-2025/cgnet && \
        /isaac-sim/python.sh -m pip install --no-cache-dir -e . || echo "cgnet installation skipped"; \
    fi && \
    # Pointnet_Pointnet2_pytorch ì„¤ì¹˜ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
    if [ -d "/AILAB-summer-school-2025/Pointnet_Pointnet2_pytorch" ]; then \
        echo "ğŸ”§ Installing Pointnet_Pointnet2_pytorch..."; \
        cd /AILAB-summer-school-2025/Pointnet_Pointnet2_pytorch && \
        /isaac-sim/python.sh -m pip install --no-cache-dir -e . || echo "Pointnet installation skipped"; \
    fi

ENTRYPOINT ["/startup.sh"]
CMD []